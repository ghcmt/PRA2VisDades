---
title: "PRA2 Visualització de Dades"
author: "Carlos Martínez Torró"
date: "2023-06-22"
output:
  prettydoc::html_pretty:
    theme: leonids
    highlight: github
    toc: true
toc-title: "Índex"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F)
```

```{r echo=FALSE}
# Carreguem les llibreries necessàries:
library(ggplot2)
library(sf)
library(dplyr)
library(tidyr)
library(openxlsx)
library(readxl)
library(kableExtra)
library(stringr)
library(data.table)
```

# Introducció
## Conjunt de dades
El dataset que hem triat és [La llengua catalana als municipis de Catalunya](https://analisi.transparenciacatalunya.cat/Societat-benestar/-catal-947-La-llengua-catalana-als-municipis-de-Ca/374c-85cu), un conjunt de dades que es centra en l'ús del català i l'evolució del seu domini per part dels habitants del país en els darrers anys. Trobem alguns subconjunts de dades dins d'aquest fitxer que estan referits al nivell municipal, altres al nivell comarcal i altres als [àmbits territorials](https://territori.gencat.cat/ca/06_territori_i_urbanisme/ordenacio_del_territori/plans_territorals/plans_territorials_parcials/ambits_funcionals/). 

Per altra banda, també utilitzarem dades geogràfiques (a nivell municipal, comarcal i d'àmbit territorial) en format GeoJSON que [hem extret del GitHub GeoStarters](https://github.com/geostarters/dades/). Aquestes dades les carregarem directament amb Tableau. 

## Càrrega de dades
Des de l'1 de juny, les dades han estat actualitzades i ja no es troben disponibles [a aquesta URL](https://analisi.transparenciacatalunya.cat/Societat-benestar/-catal-947-La-llengua-catalana-als-municipis-de-Ca/374c-85cu). El conjunt de dades original ha estat modificat per una taula on es detalla el municipi, la comarca, l'àmbit territorial i una URL on es pot accedir a un anàlisi a nivell municipal de les dades. És a dir, cada poble compta amb un PDF on s'analitza l'ús del català dins de l'àmbit municipal. Per tant, ara ja no existeix el conjunt de dades com a tal que analitzarem a continuació i que es troba a fitxer `dades-informes-catala947.xlsx`. Aquest fitxer estarà disponible al Github juntament amb aquest arxiu de RMarkdown. 

Així doncs, carreguem l'Excel amb les dades:

```{r}
df_catala <- read_xlsx("data/dades-informes-catala947.xlsx")
for (i in 1:(nrow(df_catala) + 2)) {
  df_name <- paste0("df_", i)
  file_path <- "data/dades-informes-catala947.xlsx"
  df <- readxl::read_xlsx(file_path, sheet = i)
  assign(df_name, df)
}

```

Mirem l'índex d'aquestes dades, que es troba al full 1 del fitxer Excel:

```{r}
df_1 <- read_xlsx("data/dades-informes-catala947.xlsx", sheet = 1, col_names = F)
df_1
```

I observem la distribució de les dades en aquests fulls:

```{r}
# Creem un dataframe per guardar la informació
main_df <- data.frame(stringsAsFactors = FALSE)

# Anem full per full agafant la informació rellevant:
for(i in 2:21) {
  # Fem una fila per cada dataframe amb el que ens interessa:
  df_name <- paste0("df_", i)
  n_rows <- nrow(get(df_name))
  n_cols <- ncol(get(df_name))
  new_row <- data.frame(name = df_name, rows = n_rows, cols = n_cols)
  
  # Ho afegim al dataframe que hem creat prèviament:
  main_df <- rbind(main_df, new_row)
}

# Unim els dos dataframes per fila:
summary_df <- merge(df_1, main_df, by = 0)
summary_df <- summary_df %>% 
  arrange(...2) %>%
  select(!all_of(c("Row.names", "name"))) %>% 
  rename(Dades = ...1,
         Full = ...2,
         Observacions = rows,
         Variables = cols)

# Ensenyem el resultat en una taula de Kable:
kable(summary_df, row.names = F, caption = "Subconjunts de dades del projecte #catala947") |>
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = TRUE, position = "center") 
```

Finalment, reanomenem els dataframes amb un nom que ens doni una idea més acurada del que contenen:

```{r}
# Reanomenem dataframes segons les dades que contenen:
df_origen <- df_2
df_edat_rang <- df_3
df_dades_municipi_2019 <- df_4
df_coneixement_catala_1991_2011 <- df_5
df_coneixement_catala_AT <- df_6
df_altres_llengues <- df_7
df_coneixement_cat_AT <- df_8
df_llengua_inicial_AT <- df_9
df_us_cat_perc <- df_10
df_inscripcions_CPNL <- df_11
df_inscripcions_nivell <- df_12
df_inscripcions_origen <- df_13
df_inscripcions_rest_origen <- df_14
df_parla_cat <- df_15
df_voluntariat <- df_16
df_sectors_retolacio <- df_17
df_sectors_oral <- df_18
df_ciutats_retolacio <- df_19
df_ciutats_oral <- df_20
df_LPL <- df_21
```

```{r}
taula_canvis <- data.frame(Descrip = summary_df$Dades, 
                           Nom_antic = c("df_2", "df_3", "df_4", "df_5", "df_6", 
                                         "df_7", "df_8", "df_9", "df_10", "df_11", 
                                         "df_12", "df_13", "df_14", "df_15", "df_16", 
                                         "df_17", "df_18", "df_19", "df_20", "df_21"),
                           Nom_Nou = c("df_origen", "df_edat_rang", "df_dades_municipi_2019", 
                                       "df_coneixement_catala_1991_2011", "df_coneixement_catala_AT", 
                                       "df_altres_llengues", "df_coneixement_cat_AT", "df_llengua_inicial_AT", 
                                       "df_us_cat_perc", "df_inscripcions_CPNL", "df_inscripcions_nivell", 
                                       "df_inscripcions_origen", "df_inscripcions_rest_origen", "df_parla_cat", 
                                       "df_voluntariat", "df_sectors_retolacio", "df_sectors_oral", 
                                       "df_ciutats_retolacio", "df_ciutats_oral", "df_LPL"))

kable(taula_canvis, row.names = F, caption = "Noms dels diferents subconjunts de dades",
      col.names = c("Descripció", "Nom antic", "Nom nou")) |>
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = TRUE,             position = "center") 

```

## Processament de les dades
Quan parlem de dades de municipis, podem tractar les dades a partir del seu codi únic (`idMunicipi` en el nostre conjunt de dades), un codi que identifica inequívocament cada municipi i que ens permet unir diferents subconjunts de dades. En alguns subconjunts de dades tenim dades d'àmbits territorials o comarques. Dins de l'Excel amb totes les dades no hi ha un full on estigui establerta la relació entre municipi, comarca i àmbit territorial, així que vam haver de buscar una solució per poder trobar aquesta equivalència. Inicialment, vam fer servir Python per crear un codi senzill que fes *scrapping* d'aquestes dades (el codi emprat també es troba en aquest Github amb el nom `scrapping_dades_municipis.py`). No obstant, aquest codi ja no funciona des de l'actualització de les dades, ja que la taula que contenia aquesta informació ja no es troba al web on hi era. [Les dades es poden descarregar ara directament des de la web del projecte](https://analisi.transparenciacatalunya.cat/Societat-benestar/-catal-947-La-llengua-catalana-als-municipis-de-Ca/374c-85cu). Tot i això, com ja teníem les dades prèviament gràcies a l'*scrapping* i no hi ha diferència entre aquestes i les noves dades, utilitzarem el fitxer CSV `municipis_comarques_at.csv` que vam generar amb *scrapping* (també disponible al Github). 


```{r}
equiv_at_com <- read.csv("data/municipis_comarques_at.csv", encoding = "UTF-8")
```

Al quart full del fitxer Excel, és a dir, al nostre dataframe `df_dades_municipi_2019` tenim les dades de municipi i comarca. Aprofitant això, afegirem les dades d'àmbit territorial:

```{r}
# Canviem el nom de les columnes de municipi i comarca per fer-les coincidir
# amb les existents:
equiv_df <- equiv_at_com |> select(-Descàrrega) |> 
  rename(nomMunicipi = Municipi, nomComarca = Nom.comarca)


# Fusionem ara amb les dades que teníem:
df_dades_municipi_2019 <- left_join(df_dades_municipi_2019, equiv_df, by = c("nomMunicipi", "nomComarca"))
df_dades_municipi_2019 <- df_dades_municipi_2019 |> 
  relocate(Àmbit.territorial, .after = nomComarca) |> 
  rename(nomAT = Àmbit.territorial)

# Comprovem els nivells de la nova columna
unique(df_dades_municipi_2019$nomAT)
```

Comprovem que hi ha `NA` a la nova columna. Mirem on:

```{r}
df_dades_municipi_2019[is.na(df_dades_municipi_2019$nomAT), ]
```

És una única fila que pertany al poble de Moià. A les dades originals posa que el nom de la comarca és el Bages, mentre que a les dades que hem obtingut aquest poble ja està catalogat correctament com del Moianès. Per tant, canviarem el nom de la comarca i afegirem la informació de l'àmbit territorial (*Comarques Centrals*):

```{r}
# Busquem la fila on es troba Moià:
index_na <- which(is.na(df_dades_municipi_2019$nomAT))

# Fem l'actualització de les dades:
df_dades_municipi_2019$nomComarca[index_na] <- "Moianès"
df_dades_municipi_2019$nomAT[index_na] <- "Comarques Centrals"

# Comprovem que hem fet bé el canvi:
unique(df_dades_municipi_2019$nomAT)

```

Al subconjunt que hem guardat al dataframe `df_coneixement_catala_AT` tenim les equivalències dels àmbits territorials amb els codis de cada àmbit. 

```{r}
kable(df_coneixement_catala_AT[, 1:2], row.names = F, caption = "Equivalència de l'àmbit territorial amb el codi",
      col.names = c("Codi", "Àmbit territorial")) |>
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = TRUE, position = "center") 
```

Com es pot observar a la taula, hi ha més àmbits descrits: a banda de l'àmbit general (Catalunya, AT00), també es fan subdivisions de l'àmbit metropolità. No hi ha informació disponible (o no he sigut capaç de trobar-la) que relacioni municipis amb aquestes subdivisions. Per tant, ens centrarem en els àmbits que es trobaven a les dades que vam obtenir mitjançant *scrapping*. Afegim el codi de l'àmbit territorial a les dades que acabem de generar:

```{r}
df_codi_AT <- df_coneixement_catala_AT |> 
  select(all_of(c("id", "territori"))) |> 
  rename(idAT = id, nomAT = territori)

# Fusionem ara amb les dades que teníem:
df_dades_municipi_2019 <- left_join(df_dades_municipi_2019, df_codi_AT)
df_dades_municipi_2019 <- df_dades_municipi_2019 |> 
  relocate(idAT, .after = nomAT) 

```

Ara que ja tenim un dataframe on tenim dades de municipi (amb nom i codi únic), comarca (amb nom i codi únic) i àmbit territorial (nom i codi únic), extraurem aquestes columnes i les guardarem en un nou dataframe que utilitzarem de base per respondre algunes de les preguntes que ens formulem. Ho fem d'aquesta forma ja que, en molts dels subconjunts de dades dins del fitxer Excel, només es troba disponible un dels camps: ja sigui el codi únic del municipi, el seu nom, el de la comarca o el de l'àmbit territorial. Així, tindrem tota la informació disponible en un únic dataframe.

```{r}
# Seleccionem les columnes que ens interessen:
df_base <- df_dades_municipi_2019 |> select(idMunicipi:idAT)

# Ensenyem el resultat:
df_base
```

Com es pot apreciar, tenim 947 files (una per cadascun dels 947 municipis) amb la informació necessària per cada cas. Amb el codi únic municipal podrem fer les unions necessàries amb les dades geogràfiques.

```{r}
# Guardem les dades en un CSV:
write.csv(df_base, "data/base_municipis.csv")
```


# Resultats
## Preguntes 1 i 2
Comencem amb la part de resultats. Seguirem l'estructura que vam marcar a la PRA1 i anirem responent les preguntes que allà ens plantejàvem. La primera pregunta que ens féiem era:

**Quins són els municipis i les comarques on més es parla català?**

Dins d'aquesta pregunta, ens plantejàvem unes altres relacionades amb aquesta:

* Quina ha estat l'evolució en els darrers anys?
* És també així en el seu context geogràfic més proper?
* Hi ha relació amb l'origen dels seus habitants?

Per respondre les dues primeres preguntes, ens anirem a les dades amb el coneixement de català, que les trobem al dataframe `df_coneixement_catala_1991_2011`. Com el seu nom indica, les dades més actuals són de 2011. No obstant, tenim informació de 4 anys: 1991, 1996, 2001 i 2011, el que ens hauria de permetre veure algunes tendències, tot i que les dades més recents siguin de fa més de 10 anys. Mirem una mica l'estructura de les dades:

```{r}
summary(df_coneixement_catala_1991_2011)
```

Veiem que els valors mínims de les columnes `entendre`, `parlar`, `llegir` i `escriure` són -1. Això segurament és una convenció del creador de les dades per indicar que no hi ha dades. Per tant, substituirem tots els valors de -1 per `NA`:

```{r}
# Fem el canvi
df_coneixement_catala_1991_2011[df_coneixement_catala_1991_2011 == -1] <- NA

# Mirem quants NA hi ha per columna:
colSums(is.na(df_coneixement_catala_1991_2011))
```

Com podem observar, tenim 11 valors nuls en total. 

Un cop hem tractat això, podem fer la unió de la informació completa de municipi, comarca i àmbit territorial amb aquestes dades:

```{r}
df_con_cat <- df_coneixement_catala_1991_2011 |> 
  rename(nomMunicipi = nom)
df_con_cat <- left_join(df_con_cat, df_base)
df_con_cat <- df_con_cat |> relocate(idComarca:idAT, .after = nomMunicipi)
```

Tal com hem vist al resum de les dades on hem vist els valors mínims de -1, les dades estan en freqüència absoluta. Això, tot i que també pot ser interessant en certs casos, ens desvirtuaria la visualització, ja que les ciutats amb més habitants tindrien tot el protagonisme. Per tant, utilitzarem dades de freqüència relativa. Per fer això, usarem la columna `poblacio_2_anys_i_mes` que, vista l'estructura de les dades, segurament indica quanta gent hi havia al municipi a l'any X amb més de 2 anys. Per tant, dividirem cadascuna de les columnes `entendre`, `parlar`, `llegir` i `escriure` per la columna `poblacio_2_anys_i_mes` i multiplicarem el resultat per 100 per tenir dades percentuals. 

```{r}
# Creem les columnes amb els percentatges:
df_con_cat <- df_con_cat |> 
  mutate(
    entendre_pct = round((entendre / poblacio_2_anys_i_mes) * 100, 0),
    parlar_pct = round((parlar / poblacio_2_anys_i_mes) * 100, 0),
    llegir_pct = round((llegir / poblacio_2_anys_i_mes) * 100, 0),
    escriure_pct = round((escriure / poblacio_2_anys_i_mes) * 100, 0)
  )

# Calculem també la mitjana per comarca i àmbit territorial:
df_con_cat <- df_con_cat |> 
  group_by(any, nomComarca) |> 
  mutate(
    entendre_com = round(mean(entendre_pct, na.rm = T), 0),
    parlar_com = round(mean(parlar_pct, na.rm = T), 0),
    llegir_com = round(mean(llegir_pct, na.rm = T), 0),
    escriure_com = round(mean(escriure_pct, na.rm = T), 0)
  )

df_con_cat <- df_con_cat %>%
  group_by(any, nomAT) |> 
  mutate(
    entendre_at = round(mean(entendre_pct, na.rm = T), 0),
    parlar_at = round(mean(parlar_pct, na.rm = T), 0),
    llegir_at = round(mean(llegir_pct, na.rm = T), 0),
    escriure_at = round(mean(escriure_pct, na.rm = T), 0)
  )

# I en general per Catalunya
df_con_cat <- df_con_cat %>%
  group_by(any) |> 
  mutate(
    entendre_cat = round(mean(entendre_pct, na.rm = T), 0),
    parlar_cat = round(mean(parlar_pct, na.rm = T), 0),
    llegir_cat = round(mean(llegir_pct, na.rm = T), 0),
    escriure_cat = round(mean(escriure_pct, na.rm = T), 0)
  )
```


Fem una ullada a la distribució d'aquestes dades que acabem de crear:

```{r fig.width=10, fig.height=5}
con_cat_long <- gather(df_con_cat, key = "variable", value = "valor", entendre_pct, parlar_pct, llegir_pct, escriure_pct)

ggplot(con_cat_long, aes(x = variable, y = valor, color = variable)) +
  geom_boxplot(linewidth = 0.7, outlier.shape = NA) +
  geom_jitter(width = 0.3, alpha = 0.3, size = 0.1) +
  labs(x = "Variable", y = "Percentatge (%)") +
  ggtitle("Distribució de les variables percentuals") +
  scale_color_manual(values=c("#f94144", "#f8961e", "#90be6d", "#277da1")) +
  theme_classic() +
  theme(legend.position = "none", axis.text = element_text(size = 12), 
        axis.title = element_text(size = 14))


```

Una ràpida ullada a les dades ens indica que una gran part dels catalans d'arreu entén l'idioma, també sembla que, en general, el saben llegir i parlar, mentre que la competència que més problemes ocasiona és escriure. 

Per poder analitzar millor aquestes dades amb Tableau, farem servir `pivot_longer()` per crear una nova columna que sigui `competencia` (referit a escriure, entendre, llegir i parlar) i una que sigui `nivell_territorial`, que indicarà el nivell (municipal, comarcal o àmbit territorial) al qual fa referència el percentatge de coneixement d'una competència en concret:

```{r}
df_con_longer <- df_con_cat |> 
  pivot_longer(cols = c(entendre_pct:escriure_cat),
               names_to = "competencia",
               values_to = "percentatge") |> 
  mutate(nivell_territorial = case_when(
    grepl("_pct", `competencia`) ~ "Municipi",
    grepl("_com", `competencia`) ~ "Comarca",
    grepl("_at", `competencia`) ~ "AT",
    grepl("_cat", `competencia`) ~ "Catalunya",
    TRUE ~ "Altres"
  )) |> 
  mutate(competencia = str_remove(`competencia`, "_.*") |>  str_to_title()) |>
  select(-c(entendre:poblacio_2_anys_i_mes))
```

Finalment, guardem el resultat en un arxiu CSV per analitzar-ho en Tableau. Aquesta part de la pregunta 1 està resposa a la **Història 1: Evolució**.

```{r}
write.csv(df_con_longer, "data/competencies_per_nivell_tableau.csv")
```

Pel que fa al que ens preguntàvem sobre la relació amb l'origen dels seus habitants, tenim dades d'origen dels habitants des del 2000 al 2019 al subconjunt de dades que hem anomenat com `df_origen`. Com les dades més recents de coneixement de català a nivell municipal que tenim són del 2011, filtrarem per aquest any en els dos casos i unirem les dades:

```{r}
df_ori <- df_origen |> filter(any == 2011)
df_con_cat_2011 <- df_con_cat |> filter(any == 2011)
df_con_ori_2011 <- left_join(df_con_cat_2011, df_ori)
df_con_ori_2011
```

En aquest cas les dades que tenim segons origen no tenen en compte l'edat, com en el cas del coneixement de català previ on les dades es van calcular sobre la població major de 2 anys. Per tant, recalcularem els percentatges de les competències lingüístiques sobre el total de la població, que sortirà de sumar les tres columnes d'origen: `catalunya`, `restaEstat`, `estranger`. Comencem assegurant que el total d'aquestes tres columnes sigui superior al valor que teníem de població major de 2 anys:



```{r}
# Traiem les columnes originals dels percentatges per recalcular-les
df_con_ori_2011 <- df_con_ori_2011 |> 
  select(-entendre_pct:-escriure_cat)

# Calculem el total de població:
df_con_ori_2011 <- df_con_ori_2011 |> 
  mutate(total = (catalunya + restaEstat + estranger))
```

Mirem si la nova columna de total és superior al valor que teníem de població major de 2 anys que teníem al subconjunt de dades anterior:

```{r}
sum(df_con_ori_2011$total < df_con_ori_2011$poblacio_2_anys_i_mes, na.rm = T)
```

Veiem que hi ha 77 casos on la població major de 2 anys és superior a la població total. Com això no té sentit (podríem tenir percentatges superiors al 100% en aquests municipis), recalcularem la columna total: correspondrà a la suma segons origen en aquells casos on sigui major o igual a la població major de 2 anys de l'anterior dataset; si no ho és, agafarem aquest darrer valor com a total.


```{r}
# Redefinim la columna total:
df_con_ori_2011 <- df_con_ori_2011 |> 
  mutate(total = ifelse((catalunya + restaEstat + estranger) >= poblacio_2_anys_i_mes, total, poblacio_2_anys_i_mes))

# Tornem a fer la comprovació:
sum(df_con_ori_2011$total < df_con_ori_2011$poblacio_2_anys_i_mes, na.rm = T)
```

Calculem ara els percentatges sobre la columna `total`:

```{r}
# Percentatges de cada competència:
df_con_ori_2011 <- df_con_ori_2011 |> 
  mutate(entendre_pct = round((entendre/total)*100, 0),
         escriure_pct = round((escriure/total)*100, 0),
         llegir_pct = round((llegir/total)*100, 0),
         parlar_pct = round((parlar/total)*100, 0))

# I també calculem els percentatges de població segons l'origen:
df_con_ori_2011 <- df_con_ori_2011 |> 
  mutate(catalunya_pct = round((catalunya/total)*100, 0),
         estat_pct = round((restaEstat/total)*100, 0),
         estranger_pct = round((estranger/total)*100, 0))
```


Ara ja podem transformar el dataframe a un format *longer* per treballar amb Tableau com hem fet abans:

```{r}
# Comencem amb les competències i després l'origen:
df_ori_longer <- df_con_ori_2011 |> 
  select(-c(entendre:poblacio_2_anys_i_mes)) |> 
  pivot_longer(cols = c(entendre_pct:parlar_pct),
               names_to = "competencia",
               values_to = "percentatge_comp") |> 
  pivot_longer(cols = c(catalunya_pct:estranger_pct),
               names_to = "origen",
               values_to = "percentatge_ori") |> 
  mutate(origen = case_when(
    grepl("catalunya_", origen) ~ "Catalunya",
    grepl("estat_", origen) ~ "Estat",
    grepl("estranger_", origen) ~ "Estranger",
    TRUE ~ "Altres"
  )) |> 
  mutate(competencia = str_remove(`competencia`, "_.*") |>  str_to_title()) |> 
  mutate(origen = str_remove(origen, "_.*") |>  str_to_title()) |> 
  select(-c(catalunya:total))
```

Ho guardem en un fitxer CSV per analitzar-ho:

```{r}
write.csv(df_ori_longer, "data/competencia_nivell_origen.csv")
```

Fixem-nos ara en les dades que hem guardat al dataframe `df_coneixement_cat_AT`. Són dades de les diferents competències en funció de l'origen dels habitants. Aquestes dades estan més actualitzades que les que hem utilitzat fins ara (són del 2019), tot i que, desgraciadament, només tenim informació dels àmbits territorials. No obstant, són dades directes de coneixement de l'idioma i ens podran també servir per veure si hi ha alguna diferència en el domini del català per cada origen segons la zona.

```{r}
# Filtrem primer per eliminar AT dels quals no tenim informació prèvia. És a dir,
# els subconjunts de l'àrea metropolitana:
df_coneixement_cat_AT <- df_coneixement_cat_AT |> 
  filter(id %in% unique(df_ori_longer$idAT))

# Ara transformem les dades a format "long":
df_con_AT <- df_coneixement_cat_AT |>
  pivot_longer(cols = c(entendreCatalunya:escriureEstranger),
               names_to = "competencia",
               values_to = "percentatge_comp") |> 
  mutate(origen = case_when(
    grepl("Catalunya", competencia) ~ "Catalunya",
    grepl("RestaEspanya", competencia) ~ "Estat",
    grepl("Estranger", competencia) ~ "Estranger",
    TRUE ~ "Altres"
  ))

df_con_AT$competencia <- sub("[A-Z].*", "", df_con_AT$competencia)
df_con_AT$percentatge_comp <- round(df_con_AT$percentatge_comp, 0)

df_con_AT <- df_con_AT |> 
   mutate(competencia = str_to_title(competencia))
```

Ho guardem en un fitxer XLSX (el fitxer CSV no l'estava interpretant bé Tableau):

```{r}
write.xlsx(df_con_AT, "data/coneixement_catala_origen_AT_2019.xlsx")
```

Aquests anàlisis que també s'enfoquen en l'origen dels habitants estan compresos a la visualització de Tableau **Història 2: Orígens**. Amb aquesta història i la **Història 1: Evolució** podem respondre a les següents preguntes que ens plantejàvem a la PRA1:

* Pregunta 1: Quins són els municipis i les comarques on més es parla català?
  * Quina ha estat la seva evolució en els darrers anys? 
  * És també així en el seu context geogràfic més proper?
  * Hi ha relació amb l'origen dels seus habitants?

* Pregunta 2: Quin és el domini del català de la gent no nascuda a Catalunya en comparació amb els nadius? Canvia segons el seu àmbit territorial?

## Pregunta 3
Continuarem tractant de respondre a la tercera pregunta que ens fèiem:

**Hi ha diferències en l’ús del català com a llengua habitual en cada àmbit territorial? Depèn de l’origen de la persona?**

Per respondre a aquestes preguntes podem anar a dos dels nostres subconjunts de dades: `df_llengua_inicial_AT` i `df_us_cat_perc`. Comencem pel primer, on tenim dades dels diferents àmbits territorials sobre la llengua inicial, la llengua de identificació i la llengua habitual. Ens centrarem en la informació sobre el català, el castellà i les llengües definides com "altres llengües". 

```{r}
# Filtrem per treure àmbits territorials dels quals no tenim informació:
df_llengua <- df_llengua_inicial_AT |> 
    filter(id %in% unique(df_ori_longer$idAT))

# Passem el dataframe a format "long" i ens quedem amb els valors que volem:
df_llengua_long <- df_llengua |> 
  pivot_longer(cols = c(inicialAranes:habitualNoConsta),
               names_to = "Prioritat",
               values_to = "percentatge") |> 
  mutate(Llengua = case_when(
    grepl("Catala$", Prioritat) ~ "Català",
    grepl("Castella", Prioritat) ~ "Castellà",
    grepl("AltresLlengues", Prioritat) ~ "Altres llengües",
    TRUE ~ "Altres"
  )) |> 
  filter(Llengua != "Altres", !grepl("CatalaCastella", Prioritat)) 

df_llengua_long$Prioritat <- sub("[A-Z].*", "", df_llengua_long$Prioritat)

df_llengua_long <- df_llengua_long |> 
  mutate(Prioritat = str_to_title(Prioritat),
         percentatge = round(percentatge, 0),
         Prioritat = ifelse(Prioritat == "Identificacio", "Identificació", Prioritat)) 
  

```

I ho guardem tot en un fitxer XLSX per analitzar-ho amb Tableau:

```{r}
write.xlsx(df_llengua_long, "data/prioritat_llengua_AT.xlsx")
```

Ara anem al següent dataframe `df_us_cat_perc`, on tenim dades sobre el nivell d'ús diari en percentatge del català en els diferents àmbits territorials. També tenim dades sobre saber parlar l'idioma i percentatge de llengua inicial, però com que aquests aspectes ja els hem tractat anteriorment ens centrarem en l'ús:

```{r}
# Filtrem AT i ens quedem amb les columnes desitjades:
df_us <- df_us_cat_perc |> 
  filter(id %in% unique(df_ori_longer$idAT)) |> 
  select(-c(sapParlar:llenguaInicial))

# Passem a long el dataframe:
df_us <- df_us |> 
  pivot_longer(cols = c(usaMolt:noUsaMai),
               names_to = "Ús",
               values_to = "percentatge")

df_us$Ús <- sub(".*[uU]sa", "", df_us$Ús)
df_us$percentatge <- round(df_us$percentatge*100, 0)
```

Ho guardem tot en un fitxer XLSX:

```{r}
write.xlsx(df_us, "data/usos_catala.xlsx")
```

Amb aquests dos fitxers generarem la primera part de la darrera visualització: **Història 3: Present i futur**.

## Pregunta 4
Per últim, tractarem de respondre a la darrera pregunta que ens féiem:

**Quina és l’evolució de les iniciatives per promoure l’ús del català?**

Tenim informació sobre l'evolució de les inscripcions al Consorci per a la Normalització Lingüística (CPNL) des del curs 10/11 fins el 17/18 (subconjunt `df_inscripcions_CPNL`), també tenim dades de les inscripcions segons el nivell només durant el curs 17/18 (`df_inscripcions_nivell`), també hi ha dades de les inscripcions durant el curs 17/18 segons l'origen (`df_inscripcions_origen`) i, sobre aquestes darreres dades, també tenim informació més concreta de l'origen dels estrangers que es van apuntar el curs 17/18 (`df_inscripcions_rest_origen`). Per últim, tenim dades del curs Parla.cat per comarca i en alguns municipis (`df_parla`) i també informació de voluntaris en alguns municipis (`df_voluntariat`).

No obstant, tot i tenir diferents subconjunts de dades que podrien ser útils per tenir una idea de l'evolució de les diferents iniciatives per promoure l'ús de l'idioma, les dades no són prou completes com per treure conclusions fiables sobre elles. Així doncs, hem pensat en enfocar-ho de la següent forma: **analitzarem les dades sobre les inscripcions al CPNL per any**. Amb això ens podrem fer una idea de la gent que s'ha apuntat a cursos de català en els darrers anys i veure si hi ha algun tipus de tendència o evolució en aquest número. 

Així doncs, filtrarem les dades de `df_inscripcions_CPNL` per municipi (ja que a la columna `id` també trobem codis que no sabem interpretar) i les ajuntarem per cadascun dels cursos. Després, mirarem si canvien les inscripcions any a any per àmbit territorial.

```{r}
# Filtrem la columna id per quedar-nos amb els codis dels municipis:
df_inscripcions <- df_inscripcions_CPNL |> 
  filter(id %in% unique(df_ori_longer$idMunicipi)) |> 
  rename(idMunicipi = id)

# Afegim la informació de nom de municipi, comarca i àmbit territorial que guardem
# a df_base:
df_cpnl <- left_join(df_inscripcions, df_base) |> 
  relocate(nomMunicipi:idAT, .after = idMunicipi)

# Mirem quants municipis tenim per àmbit territorial:
df_cpnl |> group_by(nomAT) |> summarise(Municipis = n())
```

Estan tots els àmbits territorials representats (tot i que d'alguns no tenim massa exemples, com de l'**Alt Pirineu i Aran**, **Ponent** o **Terres de l'Ebre**), així que podrem fer una visualització on aprofitem aquesta classificació per veure si hi ha alguna tendència. Així doncs, a continuació agruparem per any i àmbit territorial per tenir les xifres anuals de inscripcions i també l'increment d'aquestes. Utilitzarem el valor de 2010 com a valor base (100). No ho fem per municipi per dues raons:

* **No tenim dades de tots els municipis**.
* Si volem veure increments anuals respecte a un valor base, és possible que en alguns casos hi hagi **pujades que en percentatge siguin molt elevades però que, a la pràctica, no ho serien tant i podria desvirtuar la visualització** (per exemple, un augment de 1 a 4 camuflaria un increment de 100 a 150). I tampoc ho podem fer amb dades absolutes perquè municipis més grans poden eclipsar aquells més petits. Per tant, si agrupem per àmbit territorial és menys probable que pujades poc significatives a nivell absolut es tradueixin en grans percentatges.

```{r}
# Transformem per tenir les dades dels anys a cada municipi:
cpnl <- df_cpnl |> 
  group_by(idAT) |> 
  summarize(
    suma_10_11 = sum(inscripcions_10_11),
    suma_11_12 = sum(inscripcions_11_12),
    suma_12_13 = sum(inscripcions_12_13),
    suma_13_14 = sum(inscripcions_13_14),
    suma_14_15 = sum(inscripcions_14_15),
    suma_15_16 = sum(inscripcions_15_16),
    suma_16_17 = sum(inscripcions_16_17),
    suma_17_18 = sum(inscripcions_17_18))

# Passem el dataframe a format long:
df_cpnl_longer <- cpnl |> 
  pivot_longer(cols = c(suma_10_11:suma_17_18),
               names_to = "Curs",
               values_to = "Inscripcions")

# Formatem la columna:
df_cpnl_longer$Curs <- sub("suma_", "", df_cpnl_longer$Curs)
df_cpnl_longer$Curs <- sub("_.*", "", df_cpnl_longer$Curs)
df_cpnl_longer$Curs <- paste0("20", df_cpnl_longer$Curs)
  
# Creem la columna "Increment" i la formatem:
df_cpnl_longer <- df_cpnl_longer |> 
  group_by(idAT) |> 
  mutate(Increment = (Inscripcions / first(Inscripcions)) * 100)
df_cpnl_longer$Increment <- round(df_cpnl_longer$Increment, 0)
```

Guardem les dades en un fitxer XLSX:

```{r}
write.xlsx(df_cpnl_longer, "data/increment_inscripcions_cpnl.xlsx")
```

I amb aquest fitxer podem completar la darrera visualització: **Història 3: Present i futur**.

# Conclusions
Passem a la part de conclusions de l'estudi:

* El domini del català **és notable arreu del territori**: hi ha un percentatge molt elevat de gent que l'entén i també el saben llegir i parlar. L'escriptura és la competència de la qual hi ha un domini menor, però hi ha hagut una **progressió molt gran en les darreres dècades**.

* **L'evolució de les competències lingüístiques està associada al context geogràfic**.

* Hi ha una clara **associació entre el domini de les competències bàsiques de l'idioma i l'origen dels habitants**. Tot i això, també depèn del context geogràfic: **el domini de l'idioma per part de no nadius és superior a la meitat nord del país**.

* **El català no és la llengua inicial predominant en part del país** i hi ha ***un quart de la població de l'àmbit metropolità que no l'utilitza mai** en el seu dia a dia.

* Les inscripcions al Consorci per a la Normalització Lingüística estan remuntant en els darrers anys després d'ensorrar-se cap a la meitat de la dècada passada, però encara **no arriben a nivells de 2010 arreu del país**. 


